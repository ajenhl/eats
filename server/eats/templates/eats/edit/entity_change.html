{% extends "eats/edit/base.html" %}

{% block eats_style %}{{ block.super }}
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/themes/ui-lightness/jquery-ui.css" type="text/css" media="screen"/>
{{ entity_relationship_formset.media.css }}
{% endblock eats_style %}
{% block eats_js %}{{ block.super }}
<script type="application/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
<script type="application/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/jquery-ui.min.js"></script>
{{ entity_relationship_formset.media.js }}
<script type="application/javascript">
/* Prevent autoescaping of text in autocomplete. Code from http://www.arctickiwi.com/blog/jquery-autocomplete-labels-escape-html-tags */
$[ "ui" ][ "autocomplete" ].prototype["_renderItem"] = function( ul, item) {
return $( "<li></li>" ) 
  .data( "item.autocomplete", item )
  .append( $( "<a></a>" ).html( item.label ) )
  .appendTo( ul );
};
</script>
{% endblock eats_js %}

{% block eats_content %}
<h1>Edit entity</h1>

<form action="" method="post">
  {% csrf_token %}

  <div>
    {{ current_authority_form.current_authority.label_tag }}:
    {{ current_authority_form.current_authority }}
    <input name="_change_authority" type="submit" value="Change authority"/>
  </div>
</form>

<form action="" method="post">
  {% csrf_token %}

  <fieldset>
    <legend>Existences</legend>

    {{ existence_formset.management_form }}

    <table>
      <thead>
        <tr>
          <th scope="col">Delete?</th>
          <th scope="col">Authority</th>
          <th scope="col">Dates</th>
          <th></th>
        </tr>
      </thead>
      <tbody class="eats-editable-pa">
        {% for form in existence_formset %}
        <tr>
          <td>{% if form.instance %}{{ form.DELETE }}{% endif %}{{ form.assertion }}</td>
          <td>{{ form.authority }}</td>
          <td>{% if form.instance %}{% with dates=form.instance.get_dates %}{% if dates %}<ul>
          {% for date in dates %}<li><a href="{{ form.assertion.value }}/date/{{ date.get_id }}/">{{ date.assembled_form }}</a></li>{% endfor %}
          </ul>{% endif %}{% endwith %}
          <p><a href="{{ form.assertion.value }}/date/add/">Add a date</a></p>{% endif %}</td>
          <td class="errors">{% if form.errors %}<ul>
          {% for error in form.errors.values %}
          <li>{{ error }}</li>
          {% endfor %}
          </ul>{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
      <tbody class="eats-non-editable-pa">
        {% for assertion in existence_non_editable %}
        <tr>
          <td></td>
          <td>{{ assertion.authority.get_admin_name }}</td>
          <td>{% with dates=assertion.get_dates %}{% if dates %}<ul>
          {% for date in dates %}<li>{{ date.assembled_form }}</li>{% endfor %}
          </ul>{% endif %}{% endwith %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </fieldset>

  <fieldset>
    <legend>Entity types</legend>

    {{ entity_type_formset.management_form }}

    <table>
      <thead>
        <tr>
          <th scope="col">Delete?</th>
          <th scope="col">Authority</th>
          <th scope="col">Entity type</th>
          <th scope="col">Dates</th>
          <th></th>
        </tr>
      </thead>
      <tbody class="eats-editable-pa">
        {% for form in entity_type_formset %}
        <tr>
          <td>{% if form.instance %}{{ form.DELETE }}{% endif %}{{ form.assertion }}</td>
          <td>
            <div>{{ form.authority.get_admin_name }}</div>
          </td>
          <td>
            <div>{{ form.entity_type }}</div>
            {% if form.errors.entity_type %}
            <div class="errors">{{ form.errors.entity_type }}</div>
            {% endif %}
          </td>
          <td>{% if form.instance %}{% with dates=form.instance.get_dates %}{% if dates %}<ul>
          {% for date in dates %}<li><a href="{{ form.assertion.value }}/date/{{ date.get_id }}/">{{ date.assembled_form }}</a></li>{% endfor %}
          </ul>{% endif %}{% endwith %}
          <p><a href="{{ form.assertion.value }}/date/add/">Add a date</a></p>{% endif %}</td>
          <td class="errors"></td>
        </tr>
        {% endfor %}
      </tbody>
      <tbody class="eats-non-editable-pa">
        {% for assertion in entity_type_non_editable %}
        <tr>
          <td></td>
          <td>{{ assertion.authority.get_admin_name }}</td>
          <td>{{ assertion.entity_type.get_admin_name }}</td>
          <td>{% with dates=assertion.get_dates %}{% if dates %}<ul>
          {% for date in dates %}<li>{{ date.assembled_form }}</li>{% endfor %}
          </ul>{% endif %}{% endwith %}</td>
          <td></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </fieldset>

  <fieldset>
    <legend>Names</legend>

    {{ name_formset.management_form }}

    <table>
      <thead>
        <tr>
          <th scope="col">Delete?</th>
          <th scope="col">Authority</th>
          <th scope="col">Name type</th>
          <th scope="col">Language</th>
          <th scope="col">Script</th>
          <th scope="col">Display form</th>
          <th scope="col">Dates</th>
        </tr>
      </thead>
      <tbody class="eats-editable-pa">
        {% for form in name_formset %}
        <tr>
          <td>{{ form.DELETE }}{{ form.assertion }}</td>
          <td>{{ form.authority.get_admin_name }}</td>
          <td>
            <div>{{ form.name_type }}</div>
            {% if form.errors.name_type %}
            <div class="errors">{{ form.errors.name_type }}</div>
            {% endif %}
          </td>
          <td>
            <div>{{ form.language }}</div>
            {% if form.errors.language %}
            <div class="errors">{{ form.errors.language }}</div>
            {% endif %}
          </td>
          <td>
            <div>{{ form.script }}</div>
            {% if form.errors.script %}
            <div class="errors">{{ form.errors.script }}</div>
            {% endif %}
          </td>
          <td>
            <div>{{ form.display_form }}</div>
            {% if form.errors.display_form %}
            <div class="errors">{{ form.errors.display_form }}</div>
            {% endif %}
          </td>
          <td>{% if form.instance %}{% with dates=form.instance.get_dates %}{% if dates %}<ul>
          {% for date in dates %}<li><a href="{{ form.assertion.value }}/date/{{ date.get_id }}/">{{ date.assembled_form }}</a></li>{% endfor %}
          </ul>{% endif %}{% endwith %}
          <p><a href="{{ form.assertion.value }}/date/add/">Add a date</a></p>{% endif %}</td>
          <td class="errors"></td>
        </tr>
        {% endfor %}
      </tbody>
      <tbody class="eats-non-editable-pa">
        {% for assertion in name_non_editable %}
        <tr>
          <td></td>
          <td>{{ assertion.authority.get_admin_name }}</td>
          <td>{{ assertion.name.name_type.get_admin_name }}</td>
          <td>{{ assertion.name.language.get_admin_name }}</td>
          <td>{{ assertion.name.script.get_admin_name }}</td>
          <td>{{ assertion.name.display_form }}</td>
          <td>{% with dates=assertion.get_dates %}{% if dates %}<ul>
          {% for date in dates %}<li>{{ date.assembled_form }}</li>{% endfor %}
          </ul>{% endif %}{% endwith %}</td>
          <td></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </fieldset>

  <fieldset>
    <legend>Relationships</legend>

    {{ entity_relationship_formset.management_form }}

    <table>
      <thead>
        <tr>
          <th scope="col">Delete?</th>
          <th scope="col">Authority</th>
          <th scope="col">Relationship</th>
          <th scope="col">Related entity</th>
          <th scope="col">Dates</th>
        </tr>
      </thead>
      <tbody class="eats-editable-pa">
        {% for form in entity_relationship_formset %}
        <tr>
          <td>{{ form.DELETE }}{{ form.assertion }}</td>
          <td>{{ form.authority.get_admin_name }}</td>
          <td>
            <div>{{ form.relationship_type }}</div>
            {% if form.errors.relationship_type %}
            <div class="errors">{{ form.errors.relationship_type }}</div>
            {% endif %}
          </td>
          <td>
            <div>{{ form.related_entity }}</div>
            {% if form.errors.related_entity %}
            <div class="errors">{{ form.errors.related_entity }}</div>
            {% endif %}
          </td>
          <td>{% if form.instance %}{% with dates=form.instance.get_dates %}{% if dates %}<ul>
          {% for date in dates %}<li><a href="{{ form.assertion.value }}/date/{{ date.get_id }}/">{{ date.assembled_form }}</a></li>{% endfor %}
          </ul>{% endif %}{% endwith %}
          <p><a href="{{ form.assertion.value }}/date/add/">Add a date</a></p>{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
      <tbody class="eats-non-editable-pa">
        {% for entity_relationship in entity_relationship_non_editable %}
        <tr>
          <td></td>
          <td>{{ entity_relationship.authority.get_admin_name }}</td>
          {% with ert=entity_relationship.entity_relationship_type %}
          <td>{% if entity == entity_relationship.domain_entity %}{{ ert.get_admin_forward_name }}{% if entity == entity_relationship.range_entity %} and {{ ert.get_admin_reverse_name }}{% endif %}{% else %}{{ ert.get_admin_reverse_name }}{% endif %}</td>
          {% endwith %}
          <td>{{ entity.get_eats_names.0.name.display_form }}</td>
          <td></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </fieldset>

  <fieldset>
    <legend>Notes</legend>

    {{ note_formset.management_form }}

    <table>
      <thead>
        <tr>
          <th scope="col">Delete?</th>
          <th scope="col">Authority</th>
          <th scope="col">Note</th>
        </tr>
      </thead>
      <tbody class="eats-editable-pa">
        {% for form in note_formset %}
        <tr>
          <td>{% if form.initial or form.is_bound %}{{ form.DELETE }}{% endif %}{{ form.assertion }}</td>
          <td>{{ form.authority.get_admin_name }}</td>
          <td>
            <div>{{ form.note }}</div>
            {% if form.errors.note %}
            <div class="errors">{{ form.errors.note }}</div>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
      <tbody class="eats-non-editable-pa">
        {% for note in note_non_editable %}
        <tr>
          <td></td>
          <td>{{ note.authority.get_admin_name }}</td>
          <td>{{ note.note }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </fieldset>

  <div>
    <input type="submit" value="Save" name="_save"/>
  </div>
</form>

{% endblock eats_content %}


