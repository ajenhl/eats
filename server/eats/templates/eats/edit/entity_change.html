{% extends "eats/edit/base.html" %}
{% load entity_display %}

{% block eats_style %}{{ block.super }}
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/themes/ui-lightness/jquery-ui.css" type="text/css" media="screen"/>
{{ entity_relationship_formset.media.css }}
{% endblock eats_style %}
{% block eats_js %}{{ block.super }}
<script type="application/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
<script type="application/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/jquery-ui.min.js"></script>
{{ entity_relationship_formset.media.js }}
<script type="application/javascript">
/* Prevent autoescaping of text in autocomplete. Code from http://www.arctickiwi.com/blog/jquery-autocomplete-labels-escape-html-tags */
$[ "ui" ][ "autocomplete" ].prototype["_renderItem"] = function( ul, item) {
return $( "<li></li>" ) 
  .data( "item.autocomplete", item )
  .append( $( "<a></a>" ).html( item.label ) )
  .appendTo( ul );
};
</script>
<script type="application/javascript">
$(document).ready(function() {
  $('.name_part_language_script').hide();
});
</script>
{% endblock eats_js %}

{% block eats_content %}
<article class="entity-display">
<h1>Edit entity</h1>

<form action="" method="post">
  {% csrf_token %}

  <div>
    {{ current_authority_form.current_authority.label_tag }}:
    {{ current_authority_form.current_authority }}
    <input name="_change_authority" type="submit" value="Change authority"/>
  </div>
</form>

<form action="" id="entity-change-form" method="post">
  {% csrf_token %}

  <fieldset>
    <legend>Existences</legend>

    {{ existence_formset.management_form }}

    <table>
      <thead>
        <tr>
          <th scope="col">Delete?</th>
          <th scope="col">Authority</th>
          <th scope="col">Dates</th>
          <th></th>
        </tr>
      </thead>
      <tbody class="eats-editable-pa">
        {% for form in existence_formset %}
        <tr>
          <td>{% if form.instance %}{{ form.DELETE }}{% endif %}{{ form.assertion }}</td>
          <td>{{ form.authority }}</td>
          <td>{% if form.instance %}{% with dates=form.instance.get_dates %}{% if dates %}<ul>
          {% for date in dates %}<li><a href="{{ form.assertion.value }}/date/{{ date.get_id }}/">{{ date.assembled_form }}</a></li>{% endfor %}
          </ul>{% endif %}{% endwith %}
          <p><a href="{{ form.assertion.value }}/date/add/">Add a date</a></p>{% endif %}</td>
          <td class="errors">{% if form.errors %}<ul>
          {% for error in form.errors.values %}
          <li>{{ error }}</li>
          {% endfor %}
          </ul>{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
      <tbody class="eats-non-editable-pa">
        {% for assertion in existence_non_editable %}
        <tr>
          <td></td>
          <td>{{ assertion.authority.get_admin_name }}</td>
          <td>{% with dates=assertion.get_dates %}{% if dates %}<ul>
          {% for date in dates %}<li>{{ date.assembled_form }}</li>{% endfor %}
          </ul>{% endif %}{% endwith %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </fieldset>

  <fieldset>
    <legend>Entity types</legend>

    {{ entity_type_formset.management_form }}

    <table>
      <thead>
        <tr>
          <th scope="col">Delete?</th>
          <th scope="col">Entity type</th>
          <th scope="col">Dates</th>
          <th></th>
        </tr>
      </thead>
      <tbody class="eats-editable-pa">
        {% for form in entity_type_formset %}
        <tr>
          <td>{% if form.instance %}{{ form.DELETE }}{% endif %}{{ form.assertion }}</td>
          <td>
            <div>{{ form.entity_type }}</div>
            {% if form.errors.entity_type %}
            <div class="errors">{{ form.errors.entity_type }}</div>
            {% endif %}
          </td>
          <td>{% if form.instance %}{% with dates=form.instance.get_dates %}{% if dates %}<ul>
          {% for date in dates %}<li><a href="{{ form.assertion.value }}/date/{{ date.get_id }}/">{{ date.assembled_form }}</a></li>{% endfor %}
          </ul>{% endif %}{% endwith %}
          <p><a href="{{ form.assertion.value }}/date/add/">Add a date</a></p>{% endif %}</td>
          <td class="errors">{{ form.non_field_errors }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if entity_type_non_editable %}
    <section>
      <p>Other authorities classify this entity as:</p>

      <ul>
        {% for assertion in entity_type_non_editable %}
        <li>
          {{ assertion.entity_type.get_admin_name }}
          {% display_property_assertion_authority assertion %}
          {% display_property_assertion_dates assertion %}
        </li>
        {% endfor %}
      </ul>
    </section>
    {% endif %}
  </fieldset>

  <fieldset>
    <legend>Names</legend>

    {{ name_formset.management_form }}

    <table>
      <thead>
        <tr>
          <th scope="col">Delete?</th>
          <th scope="col">Name type</th>
          <th scope="col">Language</th>
          <th scope="col">Script</th>
          <th scope="col">Display form</th>
          <th scope="col">Dates</th>
          <th scope="col"></th>
        </tr>
      </thead>
      <tbody class="eats-editable-pa">
        {% for form in name_formset %}
        <tr>
          <td>{% if form.instance %}{{ form.DELETE }}{% endif %}{{ form.assertion }}</td>
          <td>
            <div>{{ form.name_type }}</div>
            {% if form.errors.name_type %}
            <div class="errors">{{ form.errors.name_type }}</div>
            {% endif %}
          </td>
          <td>
            <div>{{ form.language }}</div>
            {% if form.errors.language %}
            <div class="errors">{{ form.errors.language }}</div>
            {% endif %}
          </td>
          <td>
            <div>{{ form.script }}</div>
            {% if form.errors.script %}
            <div class="errors">{{ form.errors.script }}</div>
            {% endif %}
          </td>
          <td>
            <div>{{ form.display_form }}</div>
            {% if form.errors.display_form %}
            <div class="errors">{{ form.errors.display_form }}</div>
            {% endif %}
          </td>
          <td>{% if form.instance %}{% with dates=form.instance.get_dates %}{% if dates %}<ul>
          {% for date in dates %}<li><a href="{{ form.assertion.value }}/date/{{ date.get_id }}/">{{ date.assembled_form }}</a></li>{% endfor %}
          </ul>{% endif %}{% endwith %}
          <p><a href="{{ form.assertion.value }}/date/add/">Add a date</a></p>{% endif %}</td>
          <td class="errors">{{ form.non_field_errors }}{{ form.name_part_formset.management_form }}</td>
        </tr>
        <tr>
          <td></td>
          <td colspan="7">
            <table class="name-parts">
              {% for part_form in form.name_part_formset %}
              <tr>
                <td>{% if part_form.instance %}{{ part_form.DELETE }}{% endif %}</td>
                <td>{{ part_form.name_part_type }}</td>
                {% for id, display_form, language, script in part_form.name_part_fieldsets %}
                <td>{{ id }}{{ display_form }}<div class="name_part_language_script">{{ language }}<br/>{{ script }}</div></td>
                {% endfor %}
              </tr>
              {% endfor %}
            </table>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if name_non_editable %}
    <section>
      <p>Other authorities name this entity:</p>

      <ul>
        {% for assertion in name_non_editable %}
        <li>
          {{ assertion.name.assembled_form }}
          {% display_property_assertion_authority assertion %}
          {% display_name_metadata assertion.name %}
          {% display_property_assertion_dates assertion %}
        </li>
        {% endfor %}
      </ul>
    </section>
    {% endif %}
  </fieldset>

  <fieldset>
    <legend>Relationships</legend>

    {{ entity_relationship_formset.management_form }}

    <table>
      <thead>
        <tr>
          <th scope="col">Delete?</th>
          <th scope="col">Relationship</th>
          <th scope="col">Related entity</th>
          <th scope="col">Dates</th>
        </tr>
      </thead>
      <tbody class="eats-editable-pa">
        {% for form in entity_relationship_formset %}
        <tr>
          <td>{% if form.instance %}{{ form.DELETE }}{% endif %}{{ form.assertion }}</td>
          <td>
            <div>{{ form.relationship_type }}</div>
            {% if form.errors.relationship_type %}
            <div class="errors">{{ form.errors.relationship_type }}</div>
            {% endif %}
          </td>
          <td>
            <div>{{ form.related_entity }}</div>
            {% if form.errors.related_entity %}
            <div class="errors">{{ form.errors.related_entity }}</div>
            {% endif %}
          </td>
          <td>{% if form.instance %}{% with dates=form.instance.get_dates %}{% if dates %}<ul>
          {% for date in dates %}<li><a href="{{ form.assertion.value }}/date/{{ date.get_id }}/">{{ date.assembled_form }}</a></li>{% endfor %}
          </ul>{% endif %}{% endwith %}
          <p><a href="{{ form.assertion.value }}/date/add/">Add a date</a></p>{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if entity_relationship_non_editable %}
    <section>
      <p>Other authorities state that this entity:</p>

      <ul>
        {% for assertion in entity_relationship_non_editable %}
        <li>
          {% display_entity_relationship_property_assertion entity assertion %}
          {% display_property_assertion_authority assertion %}
          {% display_property_assertion_dates assertion %}
        </li>
        {% endfor %}
      </ul>
    </section>
    {% endif %}
  </fieldset>

  <fieldset>
    <legend>Notes</legend>

    {{ note_formset.management_form }}

    <table>
      <thead>
        <tr>
          <th scope="col">Delete?</th>
          <th scope="col">Note</th>
        </tr>
      </thead>
      <tbody class="eats-editable-pa">
        {% for form in note_formset %}
        <tr>
          <td>{% if form.instance %}{{ form.DELETE }}{% endif %}{{ form.assertion }}</td>
          <td>
            <div>{{ form.note }}</div>
            {% if form.errors.note %}
            <div class="errors">{{ form.errors.note }}</div>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if note_non_editable %}
    <section>
      <p>Other authorities say about this entity:</p>

      <ul>
        {% for assertion in note_non_editable %}
        <li class="note">
          <p>{{ assertion.note }}</p>
          <p class="note-authority">{% display_property_assertion_authority assertion %}</p>
        </li>
        {% endfor %}
      </ul>
    </section>
    {% endif %}
  </fieldset>

  <fieldset>
    <legend>Subject Identifiers</legend>

    {{ subject_identifier_formset.management_form }}

    <table>
      <thead>
        <tr>
          <th scope="col">Delete?</th>
          <th scope="col">URL</th>
        </tr>
      </thead>
      <tbody class="eats-editable-pa">
        {% for form in subject_identifier_formset %}
        <tr>
          <td>{% if form.instance %}{{ form.DELETE }}{% endif %}{{ form.assertion }}</td>
          <td>
            <div>{{ form.subject_identifier }}</div>
            {% if form.errors.subject_identifier %}
            <div class="errors">{{ form.errors.subject_identifier }}</div>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if subject_identifier_non_editable %}
    <section>
      <p>Other authorities specify the following URLs as representing this entity:</p>

      <ul>
        {% for assertion in subject_identifier_non_editable %}
        <li>
          <a href="{{ assertion.subject_identifier }}">{{ assertion.subject_identifier }}</a>
          {% display_property_assertion_authority assertion %}
        </li>
        {% endfor %}
      </ul>
    </section>
    {% endif %}
  </fieldset>

  <div>
    <input type="submit" value="Save" name="_save"/>
  </div>
</form>

</article>
{% endblock eats_content %}


